var app=getApp(),strUtils=require('../../../utils/str'),extend=require('../../../utils/extend'),ZUI=require('../../../bower_components/zui/dist/index'),orderRequest=require('./utils/request'),orderFormat=require('./utils/format'),orderPay=require('./utils/pay'),CountDown=require('../../../utils/countdown'),Coupon=require('./js/coupon'),Address=require('./js/address'),Shop=require('./js/shop'),Sms=require('./js/sms'),UnavailableGoods=require('./js/unavailableGoods'),Pay=require('./js/pay');Page(extend({},ZUI.Toast,Address,Shop,Coupon,Sms,UnavailableGoods,Pay,{data:{fetching:!0,book_key:strUtils.makeRandomString(10)+new Date().getTime(),order_no:'',orderFrom:'',address:{},origin_goods_list:[],goods_list:[],unavailable_goods:{list:[],showDetail:!1},shop:{ump_activity:[],buyer_msg:''},coupons:{showCouponList:!1,list:[],selected:{},tmp_selected:{},code:'',error:''},sms:1,is_virtual:0,showCountDown:!1,countdown:{}},onLoad(a){var b=a.dbid,c=app.db.get(b)||{},d=[],e='',f=!1,g={},h=a.orderFrom||'';if('order'==c.type?(e=c.order_no,f=!0):(g=wx.getStorageSync('trade-buy-address')||{},d=c.goods_list||[]),!e&&0==d.length){var i=app.db.set({text:'\u6CA1\u6709\u627E\u5230\u53EF\u4EE5\u4E70\u7684\u5546\u54C1~'});return void wx.redirectTo({url:'/pages/common/error/index?dbid='+i})}this.setData({origin_goods_list:d,order_no:e,orderFrom:h,showCountDown:f,address:g}),this.fetchOrderData({},()=>{},(j,k)=>{var l=app.db.set({text:j,code:k.code});wx.redirectTo({url:'/pages/common/error/index?dbid='+l})}),app.on('order-address-change',j=>{wx.setStorage({key:'trade-buy-address',data:j}),this.fetchOrderData({address:j},()=>{this.setData({address:j})})},this)},onUnload(){app.off(null,null,this)},onShow(){},createOrder(a,b){orderRequest.createOrder(this.data,c=>{var d=c.orderResultList[0].orderPayment,e={realPay:d.realPay,goodsPay:d.itemPay,postage:d.postage,activity:d.decrease},f=orderFormat.parsePaymentData(e);this.setData({order_no:c.orderNo,payment:e,payment_strs:f}),app.trigger('trade:order:create',this.data.order_no),a()},c=>{this.showZuiToast(c||'\u7F51\u7EDC\u51FA\u4E86\u70B9\u95EE\u9898\uFF0C\u518D\u70B9\u4E0B\u8BD5\u8BD5~'),b&&b(c)})},payOrder(a={}){orderPay(this.data,{success:()=>{app.trigger('trade:order:paid',this.data.order_no),a.success&&a.success();var b=app.db.set({order_no:this.data.order_no});wx.redirectTo({url:'/pages/trade/paid/index?dbid='+b})},fail:b=>{'requestPayment:fail cancel'!==b&&this.showZuiToast(b||'\u7F51\u7EDC\u6296\u4E86\u4E0B\uFF0C\u518D\u70B9\u4E0B\u8BD5\u8BD5~'),a.fail&&a.fail(b)},afterSync:a.afterSync})},validateOrder(){var a=this.data.address,b=this.data.is_virtual;if(!a.id&&!b)return wx.showModal({showCancel:!1,title:'\u63D0\u793A',content:'\u8BF7\u5148\u9009\u62E9\u4E00\u4E2A\u6536\u8D27\u5730\u5740~'}),'\u8BF7\u5148\u9009\u62E9\u4E00\u4E2A\u6536\u8D27\u5730\u5740~'},fetchOrderData(a={},b,c){wx.showToast({title:'\u6570\u636E\u52A0\u8F7D\u4E2D',icon:'loading',duration:1e4});var d=Object.assign({},this.data,a);orderRequest.fetchOrderData(d,e=>{this.setOrderData(e),wx.hideToast(),this.setData({fetching:!1}),b&&b()},(e,f)=>{wx.hideToast(),c&&c(e,f)})},setOrderData(a){this.data.order_no&&(this.setData({address:orderFormat.parseOrderAddressData(a.data.orderAddress)}),this.initCountDown(a.data)),this.setData(orderFormat.parseOrderData(a.data,this.data)),this.autoUseCoupon()},updateOrderPayment(){var a=this.data.payment,b=this.data.coupons.selected||{},c=a.goodsPay+a.postage-a.activity;b.id&&(c-=b.value),a.realPay=c;var d=orderFormat.parsePaymentData(a);this.setData({payment:a,payment_strs:d})},initCountDown(a){var b=a.shopResultList[0],c=b.order,d=1e3*c.expireTime,e=new Date().getTime();new CountDown(d-e,{onChange:(f,g)=>{this.setData({countdown:g})},onEnd:()=>{var f=app.db.set({order_no:this.data.order_no});wx.redirectTo({url:'/pages/trade/result/index?dbid='+f})}})}}));