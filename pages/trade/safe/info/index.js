var extend=require('../../../../utils/extend'),ZUI=require('../../../../bower_components/zui/dist/index'),app=getApp(),CountDown=require('../../../../utils/countdown'),str=require('../../../../utils/str'),request=require('./utils/request'),format=require('./utils/format'),messageDialogView=require('./js/message'),youzanDialogView=require('./js/youzan'),MAX_PICTURES=5;Page(extend({},ZUI.Toast,ZUI.Tab,messageDialogView,youzanDialogView,{data:{fetching:!0,safe_no:'',order_no:'',item_id:'',type:'safe-ing',timeout:0,countdown:{},countdownStr:{},goods:{},refund_process:{show:!1},tab:{selectedId:'1',list:[{id:'1',title:'\u9000\u6B3E\u8BE6\u60C5'},{id:'2',title:'\u534F\u5546\u8BB0\u5F55'}]},btns:[],log:[],messageDialog:{show:!1,message:'',imgs:[]},youzanDialog:{show:!1,message:'',imgs:[]},MAX_PICTURES},onPullDownRefresh(){this.fetchSafeData(!0)},onLoad(a){var b=app.db.get(a.dbid)||{};this.setData({safe_no:b.safe_no||'',order_no:b.order_no||''})},onShow(){this.fetchSafeData()},handleZuiTabChange({selectedId:a}){this.setData({'tab.selectedId':a})},showPicture(a){var b=a.currentTarget.dataset.src;wx.previewImage({urls:[b]})},closeSafe(){wx.showModal({title:'\u63D0\u793A',content:'\u786E\u5B9A\u8981\u5173\u95ED\u7EF4\u6743\u4E48\uFF1F',success:a=>{a.confirm&&request.close({safe_no:this.data.safe_no,order_no:this.data.order_no},()=>this.fetchSafeData())}})},backToOrder(){wx.navigateBack()},jumpToFillAddress(){var a=app.db.set({safe_no:this.data.safe_no,order_no:this.data.order_no});wx.redirectTo({url:'/pages/trade/safe/express/index?dbid='+a})},modifySafe(){var a=app.db.set({safe_no:this.data.safe_no,order_no:this.data.order_no});wx.redirectTo({url:'/pages/trade/safe/apply/index?dbid='+a})},fetchSafeData(a){this.countdown&&this.countdown.stop(),wx.showToast({title:'\u6570\u636E\u52A0\u8F7D\u4E2D',icon:'loading',duration:1e4}),request.getSafeDetail(this.data,b=>{wx.hideToast(),a&&wx.stopPullDownRefresh();var c=format.parseSafeData(b);this.setData(Object.assign({fetching:!1},c)),'agreed'==this.data.type&&this.fetchRefundProcess(),this.startTimeout()},b=>{wx.hideToast(),a&&wx.stopPullDownRefresh(),this.showZuiToast(b||'\u7F51\u7EDC\u51FA\u4E86\u70B9\u95EE\u9898~\u8BF7\u7A0D\u5019\u518D\u8BD5~')})},fetchRefundProcess(){request.getRefundProcess(this.data,a=>{var b=Object.assign({},this.data.refund_process,format.parseRefundProcessData(a));this.setData({refund_process:b})})},showRefundProcess(){this.setData({'refund_process.show':!0})},startTimeout(){this.data.timeout&&(this.countdown=new CountDown(this.data.timeout,{onChange:(a,b)=>{this.setData({countdown:a,countdownStr:b})},onEnd:()=>{this.fetchSafeData()}}))},generateKey(){return str.makeRandomString(8)+new Date().getTime()},validateImages(a=[]){return a.every(b=>{return!b.uploading})}}));