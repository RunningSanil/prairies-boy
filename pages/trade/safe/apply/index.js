var extend=require('../../../../utils/extend'),str=require('../../../../utils/str'),valid=require('../../../../utils/valid'),cdnImage=require('../../../../utils/cdnImage'),moneyHelper=require('../../../../utils/money'),multiUpload=require('../../../../utils/multi_uploader'),ZUI=require('../../../../bower_components/zui/dist/index'),request=require('./utils/request'),format=require('./utils/format'),app=getApp(),MAX_PICTURES=5;Page(extend({},ZUI.Toast,{data:{fetching:!0,safe_no:'',order_no:'',item_id:'',pay_time:'',goods_title:'',imgs:[],message:'',phone:'',money:0,moneyStr:'',method:0,methodIndex:0,express:0,expressIndex:0,reason:0,reasonIndex:0,MAX_PICTURES,methods:[],expressList:[{code:0,text:'\u672A\u6536\u5230\u8D27'},{code:1,text:'\u5DF2\u6536\u5230\u8D27'}],reasons:[],real_pay:'0.00',is_full_refund:!1,originData:{}},onLoad(a){var b=a.dbid||'',c=app.db.get(b),d={safe_no:c.safe_no||'',order_no:c.order_no||'',item_id:c.item_id||''};this.setData(d),wx.showToast({title:'\u6570\u636E\u52A0\u8F7D\u4E2D',icon:'loading',duration:1e4});var f={order_no:this.data.order_no};this.data.safe_no?f.safe_no=this.data.safe_no:f.item_id=this.data.item_id,request.getApplyBasicData(f,g=>{wx.hideToast(),this.setData(Object.assign({fetching:!1},format.parseSafeBasicData(g,this.data.safe_no))),this.data.safe_no?(this.onMoneyChange({detail:{value:this.data.moneyStr}}),this.generateSelect()):this.rebuildReasonSelect(),this.onMoneyChange({detail:{value:this.data.real_pay}})})},onImageDelete(a){var b=a.currentTarget.dataset||{},c=b.key||'',d=this.data.imgs||[],f=d.findIndex(g=>{return g.key==c});0>f||(d.splice(f,1),this.setData({imgs:d}))},onImageAdd(){var a=MAX_PICTURES-this.data.imgs.length;a=0<a?a:0,wx.chooseImage({count:a,sizeType:['compressed'],success:b=>{var c=b.tempFilePaths||[],d=this.data.imgs||[],f=[];return d.length+c.length>MAX_PICTURES?void this.showZuiToast(`最多一共只能上传${MAX_PICTURES}张图片~`):void(c.forEach(g=>{f.push({uploading:!0,src:g,srcPreview:g,key:this.generateKey()})}),this.uploadImg(f),d=d.concat(f),this.setData({imgs:d}))}})},bindMethodChange(a){var b=a.detail.value,c=this.data.methods[b]||{},d=c.code||0;this.setData({method:d,methodIndex:b}),this.rebuildReasonSelect()},bindExpressChange(a){var b=a.detail.value,c=this.data.expressList[b]||{},d=c.code||0;this.setData({express:d,expressIndex:b}),this.rebuildReasonSelect()},bindReasonChange(a){var b=a.detail.value,c=this.data.reasons[b]||{},d=c.code||0;this.setData({reason:d,reasonIndex:b})},onMessageChange(a){var b=a.detail.value;this.setData({message:b})},onPhoneChange(a){var b=a.detail.value;this.setData({phone:b})},onMoneyChange(a){var b=a.detail.value,c=moneyHelper(b).toCent();b=moneyHelper(c).toYuan(),this.setData({money:c,moneyStr:b})},onSubmitClick(){var a=this.getPostData();!this.validData(a)||this.applying||(this.applying=!0,request.submit(a,b=>{this.applying=!1;var c=app.db.set({order_no:this.data.order_no,safe_no:b.safe_no});wx.redirectTo({url:'/pages/trade/safe/info/index?dbid='+c})},b=>{this.applying=!1,this.showZuiToast(b||'\u7F51\u7EDC\u5361\u4E86\u4E0B\uFF0C\u7A0D\u5019\u518D\u8BD5\u8BD5~')}))},getPostData(){var a=this.data,b={safe_no:a.safe_no,order_no:a.order_no,method:a.method||0,reason:a.reason||0,money:a.money,phone:a.phone,message:a.message,photos:JSON.stringify(a.imgs.map(c=>c.src))};return a.safe_no||(b.item_id=a.item_id),b},validData(a){if(!a.method)return void this.showZuiToast('\u8BF7\u9009\u62E9\u5904\u7406\u65B9\u5F0F');if(!a.reason)return void this.showZuiToast('\u8BF7\u9009\u62E9\u9000\u6B3E\u539F\u56E0');if(!a.money)return void this.showZuiToast('\u8BF7\u586B\u5199\u9000\u6B3E\u91D1\u989D');if(!a.phone)return void this.showZuiToast('\u8BF7\u586B\u5199\u624B\u673A\u53F7\u7801');if(!valid.phone(a.phone)&&!valid.mobile(a.phone))return void this.showZuiToast('\u8BF7\u586B\u5199\u6B63\u786E\u7684\u624B\u673A\u53F7\u7801');if(200<a.message.length)return void this.showZuiToast('\u5907\u6CE8\u4FE1\u606F\u4E0D\u8981\u8D85\u8FC7200\u5B57~');var b=this.data.imgs.some(c=>c.uploading);return!b||void this.showZuiToast('\u90E8\u5206\u56FE\u7247\u6B63\u5728\u4E0A\u4F20\u4E2D\uFF0C\u8BF7\u7A0D\u5019~')},uploadImg(a=[]){multiUpload(a,{afterUploadSuccess:(b,c)=>{var d=this.data.imgs,f=d.findIndex(h=>{return c.key==h.key});if(!(0>f)){var g=d[f];g.src=b,g.srcPreview=cdnImage(b,'!200x200.jpg'),g.uploading=!1,this.setData({imgs:d})}},afterUploadFail:b=>{var c=this.data.imgs,d=c.findIndex(f=>{return b.key==f.key});0>d||(c.splice(d,1),this.setData({imgs:c}),this.showZuiToast('\u90E8\u5206\u56FE\u7247\u4E0A\u4F20\u51FA\u9519\uFF0C\u5DF2\u7ECF\u81EA\u52A8\u5254\u9664'))}})},generateKey(){return str.makeRandomString(8)+new Date().getTime()},generateSelect(){var a=this.data.methods.findIndex(f=>{return f.code==this.data.method})||0,b=this.data.expressList.findIndex(f=>{return f.code==this.data.express})||0,c=this.generateReasons(),d=c.findIndex(f=>{return f.code==this.data.reason})||0;this.setData({methodIndex:a,expressIndex:b,reasons:c,reasonIndex:d})},generateReasons(){var a=this.data,b=a.originData.reason_relation,c=format.getReasons(b,a.method,a.express)||[];return c},rebuildReasonSelect(){var a=this.generateReasons();this.setData({reasons:a,reasonIndex:0,reason:0})}}));