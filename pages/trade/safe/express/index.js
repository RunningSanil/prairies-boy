var app=getApp(),extend=require('../../../../utils/extend'),each=require('../../../../utils/each'),str=require('../../../../utils/str'),multiUpload=require('../../../../utils/multi_uploader'),cdnImage=require('../../../../utils/cdnImage'),valid=require('../../../../utils/valid'),ZUI=require('../../../../bower_components/zui/dist/index'),MAX_PICTURES=5;Page(extend({},ZUI.Toast,{data:{safe_no:'',order_no:'',express:[{code:0,text:'\u7269\u6D41\u516C\u53F8\u83B7\u53D6\u4E2D'}],expressIndex:0,express_no:'',phone:'',message:'',imgs:[],MAX_PICTURES},onLoad(a){var b=a.dbid,c=app.db.get(b)||{};this.setData({safe_no:c.safe_no||'',order_no:c.order_no||''}),this.fetchExpressCompany()},bindExpressChange(a){this.setData({expressIndex:a.detail.value||0})},onExpressNoChange(a){this.setData({express_no:a.detail.value||''})},onPhoneChange(a){this.setData({phone:a.detail.value||''})},onMessageChange(a){this.setData({message:a.detail.value||''})},onSubmitClick(){var a=this.getFormData();!this.validateData(a)||this.submiting||(this.submiting=!0,app.carmen({api:'kdt.trade.safe.modify/1.0.0/postExp',method:'POST',data:a,success:()=>{this.submiting=!1;var b=app.db.set({safe_no:this.data.safe_no,order_no:this.data.order_no});wx.redirectTo({url:'/pages/trade/safe/info/index?dbid='+b})},fail:()=>{this.submiting=!1}}))},onImageAdd(){var a=this.data,b=a.MAX_PICTURES-a.imgs.length;b=0<b?b:0,wx.chooseImage({count:b,sizeType:['compressed'],success:c=>{var d=c.tempFilePaths||[],f=this.data.imgs||[],g=[];return f.length+d.length>a.MAX_PICTURES?void this.showZuiToast(`最多一共只能上传${a.MAX_PICTURES}张图片~`):void(d.forEach(h=>{g.push({uploading:!0,src:h,srcPreview:h,key:this.generateKey()})}),this.uploadMessageImgs(g),f=f.concat(g),this.setData({imgs:f}))}})},onMessageImageDelete(a){var b=a.currentTarget.dataset||{},c=b.key||'',d=this.data.imgs||[],f=d.findIndex(g=>{return g.key==c});0>f||(d.splice(f,1),this.setData({imgs:d}))},uploadMessageImgs(a=[]){multiUpload(a,{afterUploadSuccess:(b,c)=>{var d=this.data.imgs,f=d.findIndex(h=>{return c.key==h.key});if(!(0>f)){var g=d[f];g.src=b,g.srcPreview=cdnImage(b,'!100x100.jpg'),g.uploading=!1,this.setData({imgs:d})}},afterUploadFail:b=>{var c=this.data.imgs,d=c.findIndex(f=>{return b.key==f.key});0>d||(c.splice(d,1),this.setData({imgs:c}),this.showZuiToast('\u90E8\u5206\u56FE\u7247\u4E0A\u4F20\u51FA\u9519\uFF0C\u5DF2\u7ECF\u81EA\u52A8\u5254\u9664'))}})},fetchExpressCompany(){app.carmen({api:'kdt.logistics.express.map/1.0.0/get',success:a=>{if(200!=a.code)return void this.showZuiToast(a.message||'\u83B7\u53D6\u7269\u6D41\u516C\u53F8\u5217\u8868\u5931\u8D25\uFF0C\u8BF7\u7A0D\u5019\u518D\u8BD5');var b=[{code:0,text:'\u8BF7\u9009\u62E9\u7269\u6D41\u516C\u53F8'}];each(a.data,(c,d)=>{'41'==d||b.push({text:c,code:d})}),a.data[41]&&b.push({code:'41',text:a.data[41]}),this.setData({express:b})},fail:a=>{this.showZuiToast(a.msg||'\u7F51\u7EDC\u6296\u4E86\u4E00\u4E0B~\u8BF7\u7A0D\u5019\u518D\u8BD5')}})},generateKey(){return str.makeRandomString(8)+new Date().getTime()},validateData(a){if(!a.express_id)return void this.showZuiToast('\u8BF7\u9009\u62E9\u7269\u6D41\u516C\u53F8');if(!a.express_no)return void this.showZuiToast('\u8BF7\u586B\u5199\u7269\u6D41\u5355\u53F7');if(!a.phone)return void this.showZuiToast('\u8BF7\u586B\u5199\u624B\u673A\u53F7\u7801');if(!valid.phone(a.phone)&&!valid.mobile(a.phone))return void this.showZuiToast('\u8BF7\u586B\u5199\u6B63\u786E\u7684\u624B\u673A\u53F7\u7801');var b=this.data.imgs.some(c=>c.uploading);return!b||void this.showZuiToast('\u90E8\u5206\u56FE\u7247\u6B63\u5728\u4E0A\u4F20\u4E2D\uFF0C\u8BF7\u7A0D\u5019~')},getFormData(){var a={safe_no:this.data.safe_no,order_no:this.data.order_no,express_no:this.data.express_no,phone:this.data.phone,remark:this.data.message},b=this.data.imgs.map(f=>f.src);a.photos=JSON.stringify(b);var c=this.data.express[this.data.expressIndex]||{},d=c.code||0;return a.express_id=d,a}}));