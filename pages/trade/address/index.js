var app=getApp(),addressRequest=require('./utils/request'),areaDataHelper=require('./utils/area'),validHelper=require('../../../utils/valid'),extend=require('../../../utils/extend'),ZUI=require('../../../bower_components/zui/dist/index');Page(extend(ZUI.Toast,{data:{fetching:!0,selected:{},list:[],status:'list',edit_data:{},area_origin:{},area:{}},onLoad(a){var b=app.db.get(a.address)||{};app.fetchAreaMapData(c=>{this.setData({area_origin:c})}),this.setData({selected:b}),this.fetchAddressList()},onAddressItemClick(a){var b=a.currentTarget.dataset.addressid,c=this.data.list.find(d=>{return d.id==b});c&&(this.changeSelectedAddress(c),wx.navigateBack())},onEditClick(a){var b=a.currentTarget,c=b.dataset,d=c.id,f=this.data.list.find(l=>{return l.id==d}),g=f.area_code||0,h=areaDataHelper.formatAreaData(g,this.data.area_origin),{provinceIndex:i,cityIndex:j,countyIndex:k}=this.findSelectedAddressIndex(g,h);f=Object.assign({},f,{provinceIndex:i,cityIndex:j,countyIndex:k,selectedValue:g}),this.setData({edit_data:f,status:'edit',area:h})},onAddClick(){var a={},b=areaDataHelper.formatAreaData(0,this.data.area_origin);a=Object.assign({},a,{provinceIndex:0,cityIndex:0,countyIndex:0,selectedValue:0}),this.setData({edit_data:a,area:b,status:'add'})},onAddressBack(){this.setData({status:'list',edit_data:{}})},onAddressSave(){var a=this.data.edit_data,b=this.data.status,c={id:a.id||'',user_name:a.user_name||'',tel:a.tel,area_code:a.area_code||0,address_detail:a.address_detail||'',postal_code:a.postal_code||'',province:a.province||'',city:a.city||'',county:a.county||''},d=this.validateAddress(c);if(!d){wx.showToast({title:'\u5730\u5740\u6570\u636E\u63D0\u4EA4\u4E2D',icon:'loading',duration:1e4});var f='edit'==b?addressRequest.save:addressRequest.add;f(c,g=>{var h=this.data.list;if(wx.hideToast(),'edit'==b){if(1!=g)return;var i=h.findIndex(j=>{return j.id==a.id});-1<i&&(h[i]=c),this.data.selected.id==a.id&&this.changeSelectedAddress(a)}else c.id=g,h.push(c);this.setData({list:h,edit_data:{},status:'list'})},g=>{wx.hideToast();var h='edit'==b?'\u7F16\u8F91\u5730\u5740\u5931\u8D25':'\u65B0\u589E\u5730\u5740\u5931\u8D25';this.showZuiToast(g.msg||h)})}},onAddressDelete(){wx.showModal({title:'\u53CB\u60C5\u63D0\u793A',content:'\u786E\u5B9A\u8981\u5220\u9664\u8FD9\u4E2A\u5730\u5740\u4E48?',success:a=>{if(a.confirm){wx.showToast({title:'\u5220\u9664\u4E2D',icon:'loading',duration:1e4});var b=this.data.edit_data;addressRequest.removeAddress(b.id,()=>{wx.hideToast();var c=this.data.list,d=c.findIndex(f=>{return f.id==b.id});c.splice(d,1),this.data.selected.id==b.id&&this.changeSelectedAddress({}),this.setData({list:c,status:'list'})},()=>{wx.hideToast(),this.showZuiToast('\u5220\u9664\u5730\u5740\u5931\u8D25, \u8BF7\u7A0D\u540E\u91CD\u8BD5~')})}}})},onInputChange(a){var b=a.currentTarget.dataset.type,c=a.detail.value||'',d=this.data.edit_data;d[b]=c,this.setData({edit_data:d})},onAreaChange(a){var b=a.detail.value||0,c=a.currentTarget.dataset.type,d=this.data.edit_data,f=this.data.area[c][b],g=f.code;if(d[`${c}Index`]!=b){var h=areaDataHelper.formatAreaData(g,this.data.area_origin),i=d.provinceIndex||0,j=d.cityIndex||0,k=d.countyIndex||0;switch(c){case'province':i=b,d.province=h.province[i].text,j=0,k=0,d.area_code=void 0;break;case'city':j=b,d.city=h.city[j].text,k=0,d.area_code=void 0;break;case'county':k=b,d.county=h.county[k].text,d.area_code=h.county[k].code;break;default:}d=Object.assign({},d,{provinceIndex:i,cityIndex:j,countyIndex:k,selectedValue:g}),this.setData({edit_data:d,area:h})}},fetchAddressList(){wx.showToast({title:'\u5730\u5740\u83B7\u53D6\u4E2D',icon:'loading',duration:1e4}),addressRequest.getAddressList(a=>{wx.hideToast(),this.setData({list:a,fetching:!1}),0==a.length&&this.onAddClick()},a=>{this.showZuiToast(a.msg||'\u5730\u5740\u5217\u8868\u83B7\u53D6\u5931\u8D25')})},changeSelectedAddress(a){app.trigger('order-address-change',a)},findSelectedAddressIndex(a,b){var c=a.toString().slice(0,2)+'0000',d=a.toString().slice(0,4)+'00',f=0,g=0,h=0;return a?(f=b.province.findIndex(({code:i})=>{return i==c}),g=b.city.findIndex(({code:i})=>{return i==d}),h=b.county.findIndex(({code:i})=>{return i==a}),{provinceIndex:f,cityIndex:g,countyIndex:h}):{provinceIndex:f,cityIndex:g,countyIndex:h}},validateAddress(a){return a.user_name?a.tel?a.area_code?a.address_detail?validHelper.phone(a.tel)||validHelper.mobile(a.tel)?void 0:(this.showZuiToast('\u8BF7\u586B\u5199\u6B63\u786E\u7684\u8054\u7CFB\u7535\u8BDD'),{type:'error',field:'tel'}):(this.showZuiToast('\u8BF7\u586B\u5199\u8BE6\u7EC6\u5730\u5740'),{type:'empty',field:'address_detail'}):(this.showZuiToast('\u8BF7\u9009\u62E9\u6536\u8D27\u5730\u533A'),{type:'empty',field:'area_code'}):(this.showZuiToast('\u8BF7\u586B\u5199\u8054\u7CFB\u7535\u8BDD'),{type:'empty',field:'tel'}):(this.showZuiToast('\u8BF7\u586B\u5199\u6536\u8D27\u4EBA\u59D3\u540D'),{type:'empty',field:'user_name'})}}));