var requestHelper=require('./utils/request'),formatHelper=require('./utils/format'),cdnImage=require('../../../utils/cdnImage'),extend=require('../../../utils/extend'),ZUI=require('../../../bower_components/zui/dist/index'),app=getApp();Page(extend({},ZUI.Toast,{data:{fetching:!0,order_no:'',order:{},express:{isShow:!1,data:{}},servicePhoneNumber:'',qrcode:{show:!1}},onLoad(a){wx.showToast({title:'\u6570\u636E\u52A0\u8F7D\u4E2D',icon:'loading',duration:1e4});var b=a.dbid,c=app.db.get(b)||{},d=c.order_no;this.setData({order_no:d})},onShow(){this.fetchOrderData(this.data.order_no),this.fetchCustomService()},onPullDownRefresh(){this.fetchOrderData(this.data.order_no,!0),this.fetchCustomService()},showGoodsMessage(a){var b=a.currentTarget.dataset.goodsid,c=a.currentTarget.dataset.skuid,d=this.data.order.items.find(g=>{return g.goods_id==b&&g.sku_id==c});if(d=Object.assign({},d),d=formatHelper.getMessagePageData(d),!!d){var f=app.db.set(d);wx.navigateTo({url:'../goods_message/index?goods='+f})}},jumpToSafe(a){var b=a.currentTarget.dataset||{},c=b.safeno||'',d=b.itemid||'',f=this.data.order_no||'',g=app.db.set({safe_no:c,item_id:d,order_no:f}),h=c?'../safe/info/index':'../safe/apply/index';wx.navigateTo({url:`${h}?dbid=${g}`})},showExpressPage(){var a=this.data.express.data||{},b=a.trace_list||[];if(0!==b.length){var c=this.data.order.items[0],d=app.db.set({order_no:this.data.order.order_no,goods_count:this.data.order.items.length,image_url:cdnImage(c.image_url,'!100x100.jpg')});wx.navigateTo({url:'/pages/trade/express/index?dbid='+d})}},handleContactCustomerService(){wx.showModal({title:this.data.servicePhoneNumber,confirmText:'\u547C\u53EB',success:a=>{a.confirm&&wx.makePhoneCall({phoneNumber:this.data.servicePhoneNumber})}})},fetchOrderData(a,b){requestHelper.fetchOrder(a,c=>{if(wx.hideToast(),b&&wx.stopPullDownRefresh(),0!=c.total_results){var d=c.trades[0];d=formatHelper.getOrderData(d),this.setData({order:d,fetching:!1}),wx.setNavigationBarTitle({title:this.data.order.state_str+'\u7684\u8BA2\u5355'}),this.fetchExpressData(a),this.fetchSafeData(a),this.data.order.isVirtual&&this.fetchVirtualCode(a)}},()=>{b?wx.stopPullDownRefresh():this.showZuiToast('\u6570\u636E\u83B7\u53D6\u5931\u8D25\uFF0C\u4E0B\u62C9\u5237\u65B0\u4E0B\u8BD5\u8BD5~')})},fetchExpressData(a){var b=this.data.order.state;6>b||requestHelper.fetchExpress(a,c=>{this.setData({'express.isShow':!0,'express.data':c||{}})})},fetchSafeData(a){requestHelper.fetchSafe(a,b=>{var c=formatHelper.parseSafeData(b,this.data.order);this.setData({order:c})})},fetchCustomService(){requestHelper.fetchCustomService(a=>{this.setData({servicePhoneNumber:a})})},fetchVirtualCode(a){var b=this.data.order.state;6>b||99==b||requestHelper.fetchVirtualCode(a,c=>{if(1===c.code){var d=c.data||{};this.setData({qrcode:{show:!0,image:d.qrcode_src}})}})}}));