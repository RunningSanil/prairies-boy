var app=getApp(),each=require('../../../utils/each'),extend=require('../../../utils/extend'),cdnImage=require('../../../utils/cdnImage'),ZUI=require('../../../bower_components/zui/dist/index'),meta=require('../../../meta');Page(extend({},ZUI.Tab,ZUI.Toast,{data:{banner:{logo:'',title:''},tags:{list:[],selectedId:0,scroll:!1},goods:{},scrollIntoView:'',goodsTagTop:0,scrollTop:0,fixedGoodsTag:!1},onLoad(){var a=app.getSystemInfoSync(),b=app.storage.get('home:dashboard:banner')||{},c=app.storage.get('home:dashboard:tags')||{};this.setData({goodsTagTop:Math.floor(345*a.windowWidth/750),systemInfo:a,banner:b,tags:c}),this.fetchHomepage(),app.on('show',()=>{this.fetchHomepage(!0)},this)},onUnload(){app.off(null,null,this)},onShow(){meta.appId||this.showZuiToast('\u8BF7\u5728meta.js\u6587\u4EF6\u4E2D\u586B\u5199appId\u540E\uFF0C\u518D\u4E0A\u4F20\u7A0B\u5E8F\u3002',3e5)},onPullDownRefresh(){this.fetchHomepage(!0)},onShareAppMessage(){return{path:'/pages/home/dashboard/index'}},fetchHomepage(a){a||wx.showToast({title:'\u52A0\u8F7D\u4E2D',icon:'loading'}),app.carmen({api:'weapp.wsc.homepage/1.0.0/get',success:b=>{var c=b.data[0],d={logo:c.logo,title:c.title},f={list:c.tags||[],scroll:3<(c.tags||[]).length},g=this.data.tags.selectedId,h=f.list.find(i=>{return i.id==g});f.selectedId=h?h.id:f.list[0].id,app.storage.set('home:dashboard:banner',d),app.storage.set('home:dashboard:tags',f),a?(this.setData({banner:d,tags:f}),this.fetchGoods(!0)):(this.setData({banner:d,tags:f,goods:{}}),this.fetchGoods()),wx.hideToast()},fail:b=>{60501===b.code?(this.setData({tags:{list:[],selectedId:0,scroll:!1},goods:{}}),this.showZuiToast('\u5C0F\u7A0B\u5E8F\u548C\u6709\u8D5E\u5E97\u94FA\u4FE1\u606F\u4E0D\u5339\u914D'),app.storage.remove('app:token')):this.showZuiToast('\u83B7\u53D6\u4FE1\u606F\u5931\u8D25')},complete:()=>{a&&wx.stopPullDownRefresh(),wx.hideToast()}})},fetchGoods(a){var b=this.data.goods,c=this.data.tags.selectedId,d=20;a&&(b={}),b[c]||(b[c]={list:a?(this.data.goods[c]||{}).list||[]:[],p:0,loading:!1,nomore:!1,nodata:!1});var f=b[c];f.nomore||f.nodata||(f.loading=!0,this.setData({goods:b}),app.carmen({api:'weapp.wsc.tag.items/1.0.0/get',query:{alias:this.getTagByTagId(c).alias,page_size:d,page_no:++f.p},success:g=>{each(g.items,h=>{h.pic_url||(h.pic_url='/upload_files/no_pic.png'),h.pic_url=cdnImage(h.pic_url,'!300x300.jpg')}),f.list=a?g.items:f.list.concat(g.items||[]),0===g.items.length&&1===f.p?f.nodata=!0:g.items.length<d&&(f.nomore=!0),this.setData({goods:b})},fail:g=>{5e4===g.code&&(f.nodata=!0,this.setData({goods:b}))},complete:()=>{f.loading=!1,this.setData({goods:b})}}))},getTagByTagId(a){var b=this.data.tags.list||[],c=b.find(d=>{return d.id==a});return c||{}},handleScroll(a){var b=a.detail,c=b.scrollTop;this.setData({fixedGoodsTag:this.data.goodsTagTop<=c}),this.data.scrollTop=c},handleScrollToUpper(){this.setData({fixedGoodsTags:!1})},handleScrollToLower(){var a=this.data.goods,b=a[this.data.tags.selectedId];b.loading||b.nomore||b.nodata||this.fetchGoods()},handleZuiTabChange(a){var b=a.selectedId,c=this.data,d=c.goods[b];this.setData({'tags.selectedId':b}),c.scrollTop>c.goodsTagTop&&(this.setData({scrollIntoView:'tags'}),setTimeout(()=>{this.setData({scrollIntoView:''})},100)),d||this.fetchGoods()}}));