var extend=require('../../../utils/extend'),receiveHelper=require('../../../components/order_receive/index'),cdnImage=require('../../../utils/cdnImage.js'),ZUI=require('../../../bower_components/zui/dist/index'),config=require('./data/config'),statusMap=config.status,app=getApp(),request=require('./utils/request');Page(extend({},ZUI.Toast,ZUI.Tab,{data:{tab:config.tab,list:config.list,animation:{order_no:'',selectedId:'',animationData:{}}},onLoad(a){var b=a.type||'all',c=this.data.tab;c.selectedId=b,this.setData({tab:c});var d=wx.createAnimation({duration:800,timingFunction:'ease',delay:0});d.opacity(0).translateX('100%').step(),this.setData({'animation.animationData':d.export()}),this.fetchMore()},onShow(){app.off('trade:order:paid',null,this)},onUnload(){app.off(null,null,this)},onPullDownRefresh(){this.clearOrderList(this.data.tab.selectedId),this.fetchMore(!0)},clearOrderList(a){var b=this.data.list,c=b[a];c.list=[],c.page=1,c.finished=!1,this.setData({list:b})},handleZuiTabChange({selectedId:a}){var b=this.data.tab,c=b.selectedId;c===a||(this.clearOrderList(a),b.selectedId=a,this.setData({tab:b}),this.fetchMore())},fetchMore(a){var b=this.data.list,c=this.data.tab.selectedId,d=b[c],f=d.finished;f||request.fetchOrderList({order_state:statusMap[c],order_mark:'wx_shop',page_no:this.data.list[c].page,use_has_next:!0},g=>{a&&wx.stopPullDownRefresh(),g.has_next||(f=!0),d.list=this.resolveOrderList(d.list,g.trades||[]),d.page++,d.finished=f,this.setData({list:b})},()=>{a&&wx.stopPullDownRefresh(),d.finished=!0,this.setData({list:b})})},resolveOrderList(a,b){var c=this.parseData(b);return a.concat(c)},parseData(a){var b=a.map(c=>{var d=!1;c.items.forEach(i=>{i.image_url=cdnImage(i.image_url,'!200x200.jpg');var j=i.sku||[],k='';j.forEach(l=>{k+=l.v+' '}),i.skuStr=k,d=d||0<i.is_visual}),c.isVirtual=d;var f=c.order_state,g=config.btns||{},h=g[c.order_state]||[];return h=h.slice(0),c.isAllowLaterReceive&&h.push('laterReceive'),'send'!=f&&'sign'!=f||d||h.push('transport'),c.isAllowConfirmReceive&&h.push('confirmReceive'),c.btns=h,c});return b},onOrderItemClicked(a){var b=a.currentTarget.dataset,c='',d=app.db.set({order_no:b.orderno,type:'order'});c=5>b.state?'/pages/trade/buy/index?dbid='+d:'/pages/trade/result/index?dbid='+d,this.listenOrderStateChange(b.orderno),wx.navigateTo({url:c})},onCancelOrder(a){var b=a.target.dataset.orderno;wx.showModal({title:'\u63D0\u793A',content:'\u8BA2\u5355\u8FD8\u672A\u4ED8\u6B3E\uFF0C\u786E\u5B9A\u8981\u53D6\u6D88\u5417?',confirmText:'\u518D\u8003\u8651\u4E0B',cancelText:'\u53D6\u6D88\u8BA2\u5355',success:c=>{c.confirm||(wx.showToast({icon:'loading',duration:1e4}),request.cancel(b,()=>{this.refreshOrder(b),wx.showToast({title:'\u53D6\u6D88\u6210\u529F',icon:'success',duration:1e3})},d=>{wx.hideToast(),this.showZuiToast(d.msg||'\u7F51\u7EDC\u6296\u4E86\u4E0B\uFF0C\u8BF7\u7A0D\u5019\u518D\u8BD5~')}))}})},onPayClick(a){var b=a.target.dataset.orderno,c=app.db.set({order_no:b,type:'order'});wx.navigateTo({url:'/pages/trade/buy/index?dbid='+c}),this.listenOrderStateChange(b)},onConfirmReceiveClick(a){var b=a.target.dataset.orderno;wx.showModal({title:'\u786E\u8BA4\u6536\u8D27',content:'\u786E\u8BA4\u6536\u8D27\u540E\uFF0C\u8BA2\u5355\u4EA4\u6613\u5B8C\u6210\uFF0C\u94B1\u6B3E\u5C06\u7ACB\u5373\u5230\u8FBE\u5546\u5BB6\u8D26\u6237\u3002',confirmText:'\u53D6\u6D88',cancelText:'\u786E\u8BA4\u6536\u8D27',success:c=>{c.confirm||(wx.showToast({icon:'loading',duration:1e4}),receiveHelper('confirmReceive',{order_no:b},{success:()=>{wx.showToast({title:'\u786E\u8BA4\u6536\u8D27\u6210\u529F',icon:'success',duration:1e3}),this.refreshOrder(b)}}))}})},onLaterReceiveClick(a){var b=a.target.dataset.orderno;wx.showModal({title:'\u5EF6\u957F\u6536\u8D27\u65F6\u95F4',content:'\u6BCF\u7B14\u8BA2\u5355\u53EA\u80FD\u5EF6\u957F\u4E00\u6B21\u6536\u8D27\u65F6\u95F4\uFF0C\u5982\u9700\u591A\u6B21\u5EF6\u957F\u8BF7\u8054\u7CFB\u5546\u5BB6\u3002',confirmText:'\u53D6\u6D88',cancelText:'\u786E\u5B9A\u5EF6\u957F',success:c=>{c.confirm||(wx.showToast({icon:'loading',duration:1e4}),receiveHelper('laterReceive',{order_no:b},{success:()=>{wx.showToast({title:'\u5EF6\u957F\u6536\u8D27\u6210\u529F',icon:'success',duration:1e3})}}))}})},showOrderExpress(a){var b=a.target.dataset.orderno,c=this.data.tab.selectedId,d=this.data.list,f=(d[c]||{}).list||[],g=f.find(i=>{return i.order_no==b});if(g){var h=app.db.set({order_no:b,goods_count:g.items.length,image_url:g.items[0].image_url});wx.navigateTo({url:'/pages/trade/express/index?dbid='+h})}},listenOrderStateChange(a){app.on('trade:order:paid',b=>{b!=a||this.refreshOrder(a)},this)},refreshOrder(a){var b=this.data.tab.selectedId,c=this.data.list,d=(c[b]||{}).list||[],f=d.findIndex(g=>{return g.order_no==a});return 0>f?void 0:'all'==b?void request.fetchOrder(a,g=>{if(!(1>g.total_results)){var h=g.trades;h=this.parseData(h);var i=h[0];d.splice(f,1,i),this.setData({list:c})}}):void this.showAnimation({order_no:a,selectedId:b},()=>{d.splice(f,1),this.setData({'animation.order_no':'','animation.selectedId':'all',list:c})})},showAnimation(a,b){this.setData({'animation.order_no':a.order_no,'animation.selectedId':a.selectedId}),setTimeout(()=>{b()},1100)}}));