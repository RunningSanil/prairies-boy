var app=getApp(),ZUI=require('../../../bower_components/zui/dist/index'),each=require('../../../utils/each'),cdnImage=require('../../../utils/cdnImage'),money=require('../../../utils/money');Page(Object.assign({},ZUI.Toast,ZUI.Quantity,{data:{fetched:!1,title:'',editMode:!1,checkedAll:!0,goodsList:[],unavailableGoodsList:[],checkedGoodsList:[],totalPrice:0,totalPriceStr:'0.00',move:{unique:null,start:{x:0,y:0},translate:!1}},onLoad(){this.fetchCart(),app.on('trade:order:create',()=>{this.fetchCart()},this)},onPullDownRefresh(){this.fetchCart()},fetchCart(){app.carmen({api:'kdt.trade.cart/1.0.0/list',success:a=>{a.data&&(this.setData(this.parse(a.data[0])),this.generateCheckedGoodsList(),this.setData({'move.unique':null,'move.translate':!1,checkedAll:this.data.goodsList.every(b=>b.checked)}))},complete:()=>{wx.stopPullDownRefresh(),this.setData({fetched:!0})}})},parse(a={}){a.checkedAll=!1,a.editMode=!1,a.goodsList=a.goods_list||[],a.unavailableGoodsList=a.unavailable_goods_list||[],delete a.goods_list,delete a.unavailable_goods_list;var b=c=>d=>{d.title=d.title||'',d.unique=[d.goods_id,d.sku_id].join('-'),d.checked=c,d.maxNum=d.limit_num?Math.min(d.limit_num,d.stock_num):d.stock_num,d.attachmentUrl=cdnImage(d.attachment_url,'!180x180.jpg'),d.payPriceStr=money(d.pay_price).toYuan(),d.skuStr=(JSON.parse(d.sku)||[]).map(f=>{return f.v}).join('\uFF0C')};return each(a.goodsList,b(!0)),each(a.unavailableGoodsList,b(!1)),a},toogleEditMode(){this.setData({editMode:!this.data.editMode,'move.unique':null,'move.translate':0})},handleCheckedAllTap(){var a=!this.data.checkedAll,b=this.data.goodsList;each(b,c=>{c.checked=a}),this.setData({checkedAll:a,goodsList:b}),this.generateCheckedGoodsList()},handleCheckedGoodsTap(a){var b=a.currentTarget.dataset.goodsUnique,c=this.data.goodsList,d=c.find(f=>f.unique===b);d&&(d.checked=!d.checked),this.setData({goodsList:c}),this.setData({checkedAll:this.data.goodsList.every(f=>f.checked)}),this.generateCheckedGoodsList()},handleZuiQuantityChange(a){var b=a.componentId,c=a.quantity;this.updateGoodsNum(b,c)},updateGoodsNum(a,b){var c=this.data.goodsList,d=c.find(f=>f.unique===a);!d||this.updatingGoodsNum||(this.updatingGoodsNum=!0,app.carmen({api:'kdt.trade.cart/1.0.0/update',data:{num:b,goods_id:d.goods_id,sku_id:d.sku_id,kdt_id:app.getKdtId()},success:()=>{d.num=b,this.setData({goodsList:c}),this.generateCheckedGoodsList()},complete:()=>{this.updatingGoodsNum=!1}}))},generateCheckedGoodsList(){var a=this.data.goodsList,b=a.filter(d=>d.checked),c=0;b.forEach(d=>{c+=d.pay_price*d.num}),this.setData({checkedGoodsList:b,totalPrice:c,totalPriceStr:money(c).toYuan()})},deleteGoods(a=[],b,c=!1){a.length&&wx.showModal({content:b,showCancel:!0,success:d=>{d.confirm&&(wx.showToast({title:'\u6B63\u5728\u5904\u7406',icon:'loading',duration:1e4,mask:!0}),app.carmen({api:'kdt.trade.cart/1.0.0/delete',method:'POST',data:{goods_list:JSON.stringify(a.map(f=>{return{goods_id:f.goods_id,sku_id:f.sku_id,kdt_id:app.getKdtId()}}))},success:()=>{var f=c?'unavailableGoodsList':'goodsList',g=this.data[f],h=a.map(j=>j.unique),i=g.filter(j=>-1===h.indexOf(j.unique));this.setData({[`${f}`]:i}),this.generateCheckedGoodsList()},fail:f=>{this.showZuiToast(f.msg)},complete:()=>{wx.hideToast()}}))}})},handleDeleteSingleGoods(a){var b=a.currentTarget.dataset,c=b.goodsUnique,d=b.isUnavailableGoods,f=d?this.data.unavailableGoodsList:this.data.goodsList;'delete'===this.data.move.state&&this.setData({'move.state':null}),this.deleteGoods(f.filter(g=>g.unique===c),'\u786E\u5B9A\u8981\u5220\u9664\u8FD9\u4E2A\u5546\u54C1\u5417\uFF1F',d)},handleDeleteMutliGoods(){var a=this.data.checkedGoodsList;this.deleteGoods(a,`确认将这 ${a.length} 个商品删除吗？`)},handleGoodsTouchStart(a){if(!this.data.editMode&&!(1<a.changedTouches.length)&&!this.data.move.translate){var b=a.currentTarget.dataset.goodsUnique,c=a.changedTouches[0];this.setData({'move.unique':b,'move.start':{x:c.pageX,y:c.pageY}})}},handleGoodsTouchEnd(a){if(!this.data.editMode&&!(1<a.changedTouches.length)&&!this.data.move.translate){var b=a.currentTarget.dataset.goodsUnique,c=a.changedTouches[0],d=this.data.move;if(b===d.unique){var f=c.pageX-d.start.x,g=c.pageY-d.start.y;0>f&&Math.abs(f)>Math.abs(g)?this.setData({'move.translate':!0}):this.setData({'move.translate':!1})}}},handleContainerTouchStart(a){var b=a.target.dataset.isDelete;this.data.move.translate&&!b&&this.setData({'move.unique':null,'move.translate':!1})},handleClearUnavailableGoods(){this.deleteGoods(this.data.unavailableGoodsList,'\u786E\u8BA4\u6E05\u7A7A\u5931\u6548\u7684\u5546\u54C1\u5417\uFF1F',!0)},handleBuy(){var a=this.data.checkedGoodsList.map(c=>{return{activityAlias:'',activityId:0,activityType:0,message:JSON.parse(c.messages),num:c.num,price:c.pay_price,skuId:c.sku_id,goodsId:c.goods_id,kdtId:app.getKdtId()}}),b=app.db.set({type:'goods',goods_list:a});wx.navigateTo({url:'/pages/trade/buy/index?orderFrom=cart&dbid='+b})},catchTouch(){},onUnload(){app.off(null,null,this)}}));