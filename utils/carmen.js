var extend=require('./extend'),url=require('./url');function noop(){}var defaultOptions={method:'GET',header:{'content-type':'application/x-www-form-urlencoded'},success:noop,fail:noop,complete:noop};module.exports=function(a){return function(c){c=extend({},defaultOptions,c);var d=()=>{var f=i=>{console.info('[carmen:success]',c.api,i),c.success(i)},g=i=>{console.error('[carmen:fail]',c.api,i),c.fail(i)},h={url:url({origin:'carmen',pathname:'/api/oauthentry/'+c.api,query:extend({access_token:a.getAccessToken(),kdt_id:a.getKdtId(),app_id:a.getAppId()},c.query)}),method:c.method,data:c.data,header:c.header,success:i=>{if(i.data.response)f(i.data.response);else try{if(40010===i.data.error_response.code)return console.info('[carmen:40010] AccessToken\u4E0D\u5B58\u5728\u6216\u5DF2\u8FC7\u671F, \u6B63\u5728\u91CD\u65B0\u767B\u5F55...'),a.globalData.hasToken=!1,a.carmen(c),void a.login();g({type:'yz:carmen',msg:i.data.error_response.msg,code:i.data.error_response.code})}catch(j){g({type:'yz:carmen',msg:'\u670D\u52A1\u5668\u9519\u8BEF',code:-99999})}},fail:i=>{g({type:'wx:request',msg:i.errMsg,code:-1})},complete:()=>{c.complete()}};console.info('[carmen:request]',c.api),wx.request(h)};a.globalData.hasToken?d():a.once('app:token:success',d)}};